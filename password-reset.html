<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Réinitialiser mot de passe - TERRASOCIAL</title>
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <link rel="stylesheet" href="css/app.css">
</head>
<body>
  <header class="topbar">
    <div class="container">
      <a class="brand" href="index.html"><span>TERRA</span>SOCIAL</a>
      <nav class="nav-links">
        <a class="btn btn-outline" href="login.html">Connexion</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <h1 class="page-title">Réinitialisation du mot de passe</h1>
    <p class="page-subtitle">Étape 1: demandez un token. Étape 2: appliquez un nouveau mot de passe.</p>

    <section class="grid grid-2">
      <article class="card">
        <h2>1) Demande de token</h2>
        <div id="flash-request"></div>
        <form id="request-form">
          <label for="request-email">Email du compte</label>
          <input id="request-email" type="email" required>
          <button class="btn btn-secondary" type="submit">Générer token</button>
        </form>
      </article>

      <article class="card">
        <h2>2) Nouveau mot de passe</h2>
        <div id="flash-reset"></div>
        <form id="reset-form">
          <label for="reset-token">Token</label>
          <input id="reset-token" required>
          <label for="new-password">Nouveau mot de passe</label>
          <input id="new-password" type="password" minlength="10" required>
          <button class="btn btn-primary" type="submit">Réinitialiser</button>
        </form>
      </article>
    </section>
  </main>

  <script src="js/runtime-config.js"></script>
  <script src="js/app-api.js"></script>
  <script>
    function flash(target, message, type) {
      document.getElementById(target).innerHTML = `<div class="flash ${type}">${message}</div>`;
    }

    document.getElementById('request-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const data = await TSApi.request('/api/auth/request-password-reset', {
          method: 'POST',
          body: JSON.stringify({ email: document.getElementById('request-email').value })
        });

        let message = data.message;
        if (data.debug_reset_token) {
          message += ` Token (dev): ${data.debug_reset_token}`;
          document.getElementById('reset-token').value = data.debug_reset_token;
        }

        flash('flash-request', message, 'ok');
      } catch (error) {
        flash('flash-request', error.message, 'err');
      }
    });

    document.getElementById('reset-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const data = await TSApi.request('/api/auth/reset-password', {
          method: 'POST',
          body: JSON.stringify({
            token: document.getElementById('reset-token').value,
            new_password: document.getElementById('new-password').value
          })
        });
        flash('flash-reset', data.message, 'ok');
      } catch (error) {
        flash('flash-reset', error.message, 'err');
      }
    });
  </script>
</body>
</html>
